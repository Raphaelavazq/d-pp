<!doctype html>
<html>
  <head>
    <title>d√ºpp Admin Login Debugger</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #1a1a2e;
        color: #eee;
      }
      .container {
        background: #16213e;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }
      h1 {
        color: #a855f7;
        margin-bottom: 10px;
      }
      h2 {
        color: #e879f9;
        margin-top: 30px;
      }
      input,
      button {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border-radius: 5px;
        border: 1px solid #444;
        background: #0f1419;
        color: #fff;
        font-size: 14px;
      }
      button {
        background: #a855f7;
        cursor: pointer;
        font-weight: bold;
        border: none;
      }
      button:hover {
        background: #9333ea;
      }
      button:disabled {
        background: #666;
        cursor: not-allowed;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 12px;
      }
      .success {
        background: #065f46;
        border-left: 4px solid #10b981;
      }
      .error {
        background: #7f1d1d;
        border-left: 4px solid #ef4444;
      }
      .info {
        background: #1e3a8a;
        border-left: 4px solid #3b82f6;
      }
      .warning {
        background: #78350f;
        border-left: 4px solid #f59e0b;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê d√ºpp Admin Login Debugger</h1>
      <p>This tool helps diagnose admin login issues</p>

      <h2>1. Test Firebase Connection</h2>
      <button onclick="testFirebaseConnection()">Test Connection</button>
      <div id="connectionResult"></div>

      <h2>2. Create New Admin User</h2>
      <input
        type="email"
        id="newEmail"
        placeholder="Admin Email (e.g., admin@dupp.com)"
      />
      <input
        type="password"
        id="newPassword"
        placeholder="Password (min 6 chars)"
      />
      <input
        type="text"
        id="newDisplayName"
        placeholder="Display Name (e.g., Admin User)"
      />
      <button onclick="createAdmin()">Create Admin Account</button>
      <div id="createResult"></div>

      <h2>3. Test Login</h2>
      <input type="email" id="testEmail" placeholder="Email to test" />
      <input type="password" id="testPassword" placeholder="Password to test" />
      <button onclick="testLogin()">Test Login</button>
      <div id="loginResult"></div>

      <h2>4. Check Firestore Rules</h2>
      <button onclick="checkFirestoreAccess()">Test Firestore Access</button>
      <div id="firestoreResult"></div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCmcCfsaYrZJPNMeHKA8vIqkgHWKGWvVCk",
        authDomain: "dupp-af67a.firebaseapp.com",
        projectId: "dupp-af67a",
        storageBucket: "dupp-af67a.firebasestorage.app",
        messagingSenderId: "176720932667",
        appId: "1:176720932667:web:f5d7395a4499facfe3911e",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.testFirebaseConnection = async function () {
        const result = document.getElementById("connectionResult");
        result.innerHTML =
          '<div class="result info">Testing connection...</div>';

        try {
          const testData = {
            projectId: firebaseConfig.projectId,
            authDomain: firebaseConfig.authDomain,
            timestamp: new Date().toISOString(),
          };
          result.innerHTML = `<div class="result success">‚úÖ Firebase Connected Successfully\n\nProject: ${testData.projectId}\nAuth Domain: ${testData.authDomain}\nTime: ${testData.timestamp}</div>`;
        } catch (error) {
          result.innerHTML = `<div class="result error">‚ùå Connection Failed\n\nError: ${error.message}</div>`;
        }
      };

      window.createAdmin = async function () {
        const result = document.getElementById("createResult");
        const email = document.getElementById("newEmail").value;
        const password = document.getElementById("newPassword").value;
        const displayName = document.getElementById("newDisplayName").value;

        if (!email || !password) {
          result.innerHTML =
            '<div class="result error">‚ùå Please fill in email and password</div>';
          return;
        }

        result.innerHTML =
          '<div class="result info">Creating admin user...</div>';

        try {
          // Create user in Firebase Auth
          const { user } = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );

          // Create admin profile in Firestore
          await setDoc(doc(db, "users", user.uid), {
            uid: user.uid,
            email: user.email,
            displayName: displayName || "Admin",
            role: "admin",
            status: "active",
            createdAt: new Date(),
            updatedAt: new Date(),
          });

          result.innerHTML = `<div class="result success">‚úÖ Admin User Created Successfully!

Email: ${email}
UID: ${user.uid}
Role: admin
Status: active

You can now login at: http://localhost:5173/admin</div>`;

          // Sign out after creating
          await signOut(auth);
        } catch (error) {
          let errorMsg = error.message;
          if (error.code === "auth/email-already-in-use") {
            errorMsg =
              "This email is already registered. Try logging in or use a different email.";
          } else if (error.code === "auth/weak-password") {
            errorMsg = "Password should be at least 6 characters.";
          } else if (error.code === "auth/invalid-email") {
            errorMsg = "Invalid email format.";
          }
          result.innerHTML = `<div class="result error">‚ùå Failed to Create Admin\n\nError: ${errorMsg}\nCode: ${error.code}</div>`;
        }
      };

      window.testLogin = async function () {
        const result = document.getElementById("loginResult");
        const email = document.getElementById("testEmail").value;
        const password = document.getElementById("testPassword").value;

        if (!email || !password) {
          result.innerHTML =
            '<div class="result error">‚ùå Please fill in email and password</div>';
          return;
        }

        result.innerHTML = '<div class="result info">Testing login...</div>';

        try {
          const userCredential = await signInWithEmailAndPassword(
            auth,
            email,
            password
          );
          const user = userCredential.user;

          // Try to fetch user profile from Firestore
          const userDoc = await getDoc(doc(db, "users", user.uid));

          if (userDoc.exists()) {
            const userData = userDoc.data();
            result.innerHTML = `<div class="result success">‚úÖ Login Successful!

Email: ${user.email}
UID: ${user.uid}
Role: ${userData.role || "NOT SET"}
Status: ${userData.status || "NOT SET"}
Display Name: ${userData.displayName || "NOT SET"}

${userData.role === "admin" ? "‚úÖ This user has ADMIN access" : "‚ö†Ô∏è This user is NOT an admin"}</div>`;
          } else {
            result.innerHTML = `<div class="result warning">‚ö†Ô∏è Login Successful BUT No Firestore Profile

Email: ${user.email}
UID: ${user.uid}

The user authenticated successfully, but there's no document in the 'users' collection.
This will cause the "Missing permissions" error.

Fix: Create a Firestore document for this user.</div>`;
          }

          await signOut(auth);
        } catch (error) {
          let errorMsg = error.message;
          if (
            error.code === "auth/wrong-password" ||
            error.code === "auth/user-not-found"
          ) {
            errorMsg = "Invalid email or password";
          } else if (error.code === "auth/invalid-email") {
            errorMsg = "Invalid email format";
          } else if (error.code === "auth/too-many-requests") {
            errorMsg =
              "Too many failed attempts. Try again later or reset your password.";
          }
          result.innerHTML = `<div class="result error">‚ùå Login Failed\n\nError: ${errorMsg}\nCode: ${error.code}</div>`;
        }
      };

      window.checkFirestoreAccess = async function () {
        const result = document.getElementById("firestoreResult");
        result.innerHTML =
          '<div class="result info">Checking Firestore access...</div>';

        try {
          const currentUser = auth.currentUser;
          if (!currentUser) {
            result.innerHTML =
              '<div class="result warning">‚ö†Ô∏è Not Logged In\n\nPlease test login first to check Firestore access.</div>';
            return;
          }

          const userDoc = await getDoc(doc(db, "users", currentUser.uid));

          if (userDoc.exists()) {
            result.innerHTML = `<div class="result success">‚úÖ Firestore Access OK\n\nUser document found and readable.</div>`;
          } else {
            result.innerHTML = `<div class="result error">‚ùå Firestore Access Issue\n\nUser document not found. This causes permission errors.</div>`;
          }
        } catch (error) {
          result.innerHTML = `<div class="result error">‚ùå Firestore Error\n\nError: ${error.message}\nCode: ${error.code}</div>`;
        }
      };
    </script>
  </body>
</html>
